<% content_for(:title, "Auction: #{@artwork.title}") %>

<div class="page-content">
  <div class="container">
    <div class="artwork-detail">
      <!-- Artwork Image -->
      <div class="artwork-image-main">
        <% if @artwork.image.attached? %>
          <%= image_tag @artwork.image.variant(resize_to_limit: [1200, 1600]), alt: @artwork.title %>
        <% else %>
          <div style="width:100%;aspect-ratio:3/4;background:linear-gradient(135deg, #2a2a3e, #1a1a2e);display:flex;align-items:center;justify-content:center;">
            <span style="font-family:var(--font-display);font-size:5rem;opacity:0.15;color:var(--color-accent);"><%= @artwork.title.first(2).upcase %></span>
          </div>
        <% end %>
      </div>

      <!-- Auction Info -->
      <div class="artwork-info">
        <div class="artwork-artist">
          <div class="artwork-artist-avatar">
            <div style="width:100%;height:100%;background:var(--color-accent);display:flex;align-items:center;justify-content:center;font-size:0.8rem;color:var(--color-bg);font-weight:700;">
              <%= @artwork.artist.first_name.first %><%= @artwork.artist.last_name.first %>
            </div>
          </div>
          <div>
            <span class="artwork-artist-name"><%= @artwork.artist.full_name %></span>
            <span class="text-muted" style="display:block;font-size:0.75rem;">Seller: @<%= @auction.seller.username %></span>
          </div>
        </div>

        <h1 class="artwork-title-large"><%= @artwork.title %></h1>

        <div class="artwork-details-grid">
          <div class="artwork-detail-item">
            <label>Category</label>
            <span><%= @artwork.category.name %></span>
          </div>
          <div class="artwork-detail-item">
            <label>Medium</label>
            <span><%= @artwork.medium || "Not specified" %></span>
          </div>
          <div class="artwork-detail-item">
            <label>Starting Price</label>
            <span><%= number_to_currency(@auction.starting_price) %></span>
          </div>
          <div class="artwork-detail-item">
            <label>Total Bids</label>
            <span><%= @auction.bids_count %></span>
          </div>
        </div>

        <!-- Auction Panel -->
        <div class="auction-panel">
          <div class="auction-price-row">
            <div>
              <span class="auction-current-label">Current Bid</span>
              <div class="auction-current-price"><%= number_to_currency(@auction.current_price) %></div>
            </div>
            <div style="text-align:right;">
              <% if @auction.highest_bidder %>
                <span class="auction-current-label">Highest Bidder</span>
                <div style="color:var(--color-text);font-size:1rem;">@<%= @auction.highest_bidder.username %></div>
              <% end %>
            </div>
          </div>

          <% if @auction.live? %>
            <div class="auction-countdown" data-controller="countdown" data-countdown-deadline-value="<%= @auction.ends_at.iso8601 %>">
              <div class="countdown-unit">
                <span class="countdown-value" data-countdown-target="days">--</span>
                <span class="countdown-label">Days</span>
              </div>
              <div class="countdown-unit">
                <span class="countdown-value" data-countdown-target="hours">--</span>
                <span class="countdown-label">Hours</span>
              </div>
              <div class="countdown-unit">
                <span class="countdown-value" data-countdown-target="minutes">--</span>
                <span class="countdown-label">Minutes</span>
              </div>
              <div class="countdown-unit">
                <span class="countdown-value" data-countdown-target="seconds">--</span>
                <span class="countdown-label">Seconds</span>
              </div>
            </div>

            <% if user_signed_in? && current_user != @auction.seller %>
              <div data-controller="bid" data-bid-minimum-value="<%= @auction.minimum_bid %>" data-bid-current-value="<%= @auction.current_price %>">
                <%= form_with model: @bid, url: auction_bids_path(@auction), class: "bid-form", data: { action: "submit->bid#validate" } do |f| %>
                  <div class="bid-input-group">
                    <span class="currency">$</span>
                    <button type="button" class="bid-adjust" data-action="click->bid#decrement">-</button>
                    <%= f.number_field :amount, step: 0.01, min: @auction.minimum_bid, value: @auction.minimum_bid, data: { bid_target: "amount" } %>
                    <button type="button" class="bid-adjust" data-action="click->bid#increment">+</button>
                  </div>
                  <%= f.submit "Place Bid", class: "btn btn-primary" %>
                <% end %>
                <p class="form-hint mt-sm">Minimum bid: <%= number_to_currency(@auction.minimum_bid) %></p>
                <div class="form-error hidden" data-bid-target="error"></div>
              </div>
            <% elsif !user_signed_in? %>
              <p style="color:var(--color-text-muted);margin-top:var(--space-lg);">
                <%= link_to "Sign in", new_user_session_path %> to place a bid.
              </p>
            <% end %>
          <% else %>
            <div class="auction-ended">
              Auction has ended
              <% if @auction.highest_bidder %>
                <br><span style="font-size:0.9rem;color:var(--color-text-secondary);">
                  Won by @<%= @auction.highest_bidder.username %> for <%= number_to_currency(@auction.current_price) %>
                </span>
              <% end %>
            </div>
          <% end %>

          <!-- Watchlist -->
          <% if user_signed_in? && @auction.live? %>
            <div style="margin-top:var(--space-lg);padding-top:var(--space-lg);border-top:1px solid var(--color-border);">
              <% if @watching %>
                <%= link_to "Remove from Watchlist", unwatch_auction_path(@auction), data: { turbo_method: :delete }, class: "btn btn-ghost btn-sm" %>
              <% else %>
                <%= link_to "Add to Watchlist", watch_auction_path(@auction), data: { turbo_method: :post }, class: "btn btn-ghost btn-sm" %>
              <% end %>
            </div>
          <% end %>
        </div>

        <!-- Bid History -->
        <% if @bids.any? %>
          <div class="bid-history">
            <h3 class="bid-history-title">Bid History</h3>
            <% @bids.each do |bid| %>
              <div class="bid-item">
                <span class="bid-item-user">@<%= bid.bidder.username %></span>
                <span class="bid-item-amount"><%= number_to_currency(bid.amount) %></span>
                <span class="bid-item-time"><%= time_ago_in_words(bid.created_at) %> ago</span>
              </div>
            <% end %>
          </div>
        <% end %>

        <%= link_to "View Artwork Details", artwork_path(@artwork), class: "btn btn-outline mt-lg" %>
      </div>
    </div>
  </div>
</div>
